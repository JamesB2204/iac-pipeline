name: CI-software-quality-checks
run-name: Checking code quality for${{ github.actor }}
on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
    secrets:
      cloud_token:
        required: true
env:
  higher_branch: ${{ inputs.branch == 'develop' && 'main' }}  
jobs:
  terraform-quality-checks:
    runs-on: ubuntu-24.04
    steps:   
      - name: checkout lower branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
      
      - name: Fetch base branch
        run: git fetch origin ${{ env.higher_branch }}:${{ env.higher_branch }}
      
      - uses: 'google-github-actions/auth@v3'
        with:
          credentials_json: '${{ secrets.cloud_token }}'

      - name: Set up python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: 3.9
      
      - name: set up terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.5"

      - name: Install Terragrunt and OpenTofu
        uses: gruntwork-io/terragrunt-action@v3
        with:
          tg_version: '0.99.1'
          tf_path: "terraform"

          # please view:
      # https://www.checkov.io/8.Outputs/SARIF.html
      # https://docs.github.com/en/code-security/how-tos/scan-code-for-vulnerabilities/integrate-with-existing-tools/uploading-a-sarif-file-to-github#uploading-a-code-scanning-analysis-with-github-actions
      - name: start quality checks
        shell: bash
        run: |
          echo "$PWD"

          echo "Starting Terraform code quality checks"

          terragrunt run --all init

          terragrunt run --all --filter-affected -- plan  -out=/tmp/tfplan

          terragrunt run -- show -json /tmp/tfplan > /tmp/tfplan.json

          checkov -f /tmp/tfplan.json --output sarif --output-file-path /tmp/
